---
title: Playing around the SIR
date: February 11, 2020
author: Melodie Monod
runtime: shiny 
output: 
  prettydoc::html_pretty:
    theme: tactile
    highlight: github
---

## SIR model
The dynamism of infectious disease spread is often formulated with mathematical models. A common way to do so is to consider that each individual in the population passes through states, in order, during the observation period. Individuals at the same state form a group. Disease dynamics are generated by the flux of individuals from one group to another. The most famous compartmental model is called the epidemic SIR model (or the Kermack and McKendrick) in which members of the population are classified in one of three states: susceptible, infected or recovered. We denote the number of susceptible members at time $t$ by $S(t)$, infected and infectious by $I(t)$ and removed, recovered, immune or dead by $R(t)$. At all time, $S(t)+I(t)+R(t) = N$ where $N$ is the population size. The disease dynamics are expressed by
\begin{aligned} 
  \frac{dS(t)}{dt} &= - \frac{\beta I(t) S(t)} {N}, \\
  \frac{dI(t)}{dt} &= \frac{\beta I(t) S(t)} {N} - \gamma I(t), \\
  \frac{dR(t)}{dt} &= \frac{\beta I(t) S(t)} {N}.
\end{aligned} 
where $\beta$ is the average transmission rate and $1/\gamma$ is the average period of infectiousness (i.e., period for which an individual is infectious). This model assumes a close population (no birth, death or migration), constant rates over the entire observational period and a well mixed population (a person has the same probability to meet any other person).

I found a very intuitive derivation of the SIR in Hethcote (1995). Although the author uses heterogeneous mixing (population is divided into groups), the generalisation to one group is easily done.
The transmission rate $\beta$ can be seen as the average number of adequate contact per unit time between one person, say $i$, to the rest of the population. Here an adequate contact is an encounter which is sufficient for transmiting the infection if the person $i$ is susceptible. Therefore $\beta S(t)$ is the average number of adequate contact per unit time happening in the population. Remembering than $I(t)/N$ is the proportion of infected just before time $t$, the number of new cases is $\beta S(t) I(t)/N$.

## Basic reproduction number
The basic reproduction number, denote $R_0$ is the expected number of secondary cases assuming that the population i entirely susceptible except for the index case, at the initial stage ($S(0) \approx N$ and $I(0) = 1$). In this case the number of secondary cases is $\beta$ and remembering that $1/\gamma$ is the time until recovery, we obtain $R_0 = \beta/\gamma$. For a rigorous derivation of the reproduction number, see Perasso (2018). Why do epidemiologist tend to care about the reproduction rate so much? Because it informs on weather an epidemic occurs, that is the number of infecteds increases at the outset, 
\begin{aligned} 
  \frac{\beta I(0) S(0)} {N} - \gamma I(0) &> 0, \\
  \frac{\beta}{\gamma} = R_0 &> 1.
\end{aligned} 

If $R_0<1$, the infected individual produces, on average, less than one new infected individual and hence the disease dies out. If $R_0>1$, the infected individual produces, on average, more than one new infected individual, and hence the disease spreads into the susceptible population.

## Deterministic model
First we assume that the flux of individual between the states is deterministic. In other words, given the rates and the initial state, there is no uncertainty in the number of individuals moving from one stage to the next. Everything can be known, with certainty at time $t_0$.

### Application
In this context we can evaluate the SIR for different value of $\beta$, $\gamma$ and $s(0) = S(0)/N$ at time $t$ with,
$$ I(t) = \int_0^t \frac{\beta I(u) S(u)} {N} - \gamma I(u) du $$
and similarly for $S(t)$ and $I(t)$. We use the numerical ODE solver *ODIN*. It is an R package with an DSL written in R's syntax, but compiling in C in order to efficiently solve the system. We use the following R code,

```{r,echo = T, results='hide', warning=FALSE, message=FALSE}
library(data.table)
library(dplyr)
library(reshape2)
library(ggplot2)
library(dde)
library(odin)

sir = function(beta, gamma, s0, t)
{
  sir.solve <- odin::odin({
    # Dynamics
    update(S) <- S - beta * I * S
    update(I) <- I + beta * I * S - gamma * I
    update(R) <- R + gamma * I
    
    # Initial states:
    initial(S) <- s0
    initial(I) <- 1 - s0
    initial(R) <- 0
    
    # User defined parameters - default in parentheses:
    s0 <- user(.99)
    beta <- user(.2)
    gamma <- user(.1)
  }, verbose = FALSE)

  cat("start ODE solver with ODIN \n")
  time.start_odin <- Sys.time()
  fit.ODIN = sir.solve(s0 = s0, beta = beta, gamma = gamma)
  time.end_odin <- Sys.time()
  cat("end ODE solver with ODIN \n")
  duration_odin <- time.end_odin - time.start_odin
  cat("duration ODE solver with ODIN:", duration_odin, "\n")
  
  SIR.ODIN <- as.data.table(fit.ODIN$run(t)) %>%
    melt(id.vars = "step") %>%
    rename(t = step, States = variable)
  
  p = ggplot(data = SIR.ODIN, aes(x = t, y = value, col = States)) +
    geom_line() + 
    labs(x = "time", y = "Proportion of the population") +
    theme_minimal() +
    theme(text = element_text(size=18)) + 
    annotate(geom="text", x=112, y=.9, label=paste("Computing time:", round(duration_odin, 4), "s")) + 
    annotate(geom="text", x=112, y=.85, label = paste("R_0 =", round(beta/gamma, 2)))
return(p)
}
```

```{r, echo=FALSE}
inputPanel(
  sliderInput('beta', label = 'beta:',
  min = 0, max = 2, value = .2, step = .01),

  sliderInput('gamma', label = 'gamma:',
  min = 0, max = 2, value = .1, step = .01),

  sliderInput('s0', label = 's0:',
  min = 0, max = 1, value = .99, step = .01)
)

renderPlot({
  par(mar = c(4, 4, .1, .5))
  sir(input$beta, input$gamma, input$s0, 1:120)
})
```



## References
Hethcote, H. (1995), ‘Modeling heterogeneous mixing in infectious disease dynamics’,Modelsfor infectious human diseases Their structure and relation to data.

Perasso, A. (2018), ‘An introduction to the basic reproduction number in mathematical epi-demiology’,ESAIM: PROCEEDINGS AND SURVEYS62, 123–138
